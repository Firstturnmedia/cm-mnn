<?

/**
 * Implements hook_form_alter().
 */
function cm_crew_connect_form_alter(&$form, &$form_state, $form_id) {
  dpm($form, 'form');
  dpm($form_state, 'form_state');
  dsm($form);

 
  
/*http://cm-testing.mnn.openflows.com/node/add/crew-connect-request?field_crew_project_id=773906&destination=user/207293/cm_crew_connect

http://cm-testing.mnn.openflows.com/node/779616/edit?destination=user/207293/cm_crew_connect
*/
  //The Crew Connect Request Node Form
  if ($form_id == 'crew_connect_request_node_form') {
    drupal_set_message(t("Please make sure you have a Confirmed Reservation for the relevant facility and time prior to asking for a Crew."), 'warning');
    
    $url_parts = explode('/', request_uri());
 
dpm($url_parts, 'url_parts');
 
    
    // HERE IS WHERE THE ACTION WILL GO THAT OCCURS FOR EDITS
    // RETURN

    
    
   
    // NO NID - FIRST TIME THRU - SETUP FORM
    $project_nid = filter_input(INPUT_GET, 'field_crew_project_id');
    $project = $project_nid ? node_load($project_nid) : NULL;

    dpm($project, 'project');
    
    if (!$project && $form['nid']) {
      $request = 
	$form['field_crew_project_id'][LANGUAGE_NONE][0]
	['target_id']['#entity'];

      $project_nid = 
	cm_crew_connect_get_single_field_value($request, 
					       'field_crew_project_id',
					       'target_id');
      $project = $project_nid ? node_load($project_nid) : NULL;
    }
    
    /*******************************
    // PHASE 2 interstitial form
    // SEE IF USER HAS CONFIRMED PROJECT SETTINGS YET
    $is_project_confirmed = 
      (isset($_GET['project_confirm']) && $_GET['project_confirm'] == 'true')?
      TRUE : FALSE;

    if (!$is_project_confirmed === TRUE) {
      drupal_goto("crew-request-project-confirm/$project_id");
      return;
    } 
    *********************************/
    
    // FIXME: author will be dependent on the role of the user - staff can 
    // set the producer's name which then sets the author of the node - 
    // this code will need to be added
    
    // set the name of the producer based on the author of the request    
    $author = $form['uid']['#value'] ? $form['uid']['#value'] : NULL;
    $name = cm_crew_connect_get_display_name($author);
    // get the public email of the author of the request
    $public_email = cm_crew_connect_get_public_email($author);    
    
    
   $form['field_crew_producer_name'][LANGUAGE_NONE][0]
      ['value']['#default_value'] = $name;

    $form['field_crew_public_description'][LANGUAGE_NONE][0]
      ['value']['#default_value'] = 
      cm_crew_connect_get_single_field_value($project, 'field_description');
     
    $location_tid = 
      cm_crew_connect_get_single_field_value($project, 
					     'field_location',
					     'tid');              
    $term = $location_tid ? taxonomy_term_load($location_tid) : NULL;    
    $form['field_crew_location'][LANGUAGE_NONE][0]
      ['value']['#default_value'] = $term ? $term->name : "";
          
   $form['field_crew_public_url'][LANGUAGE_NONE][0]
      ['value']['#default_value'] = 
                cm_crew_connect_get_single_field_value($project, 
					     'field_project_public_url');

    $language_tid = 
      cm_crew_connect_get_single_field_value($project, 
					     'field_pbcore_languages',
					     'tid');
    $term = $language_tid ? taxonomy_term_load($language_tid) : NULL;
    $form['field_crew_language'][LANGUAGE_NONE][0]['value']['#default_value'] =
                $term ? $term->name : "";

    $form['field_crew_requesters_pub_email'][LANGUAGE_NONE][0]
      ['value']['#default_value'] = $public_email;                

    $form['field_crew_producer_name'][LANGUAGE_NONE]['#disabled'] = TRUE;
    $form['field_crew_public_description'][LANGUAGE_NONE]['#disabled'] = TRUE;
    $form['field_crew_location'][LANGUAGE_NONE]['#disabled'] = TRUE;    
    $form['field_crew_public_url'][LANGUAGE_NONE]['#disabled'] = TRUE;
    $form['field_crew_language'][LANGUAGE_NONE]['#disabled'] = TRUE;
    $form['field_crew_requesters_pub_email'][LANGUAGE_NONE]['#disabled'] = TRUE;    
    
    if ($project) {
      $form['title'] = array('#type'=>'hidden',
			     '#value'=>$project->title);
    }

    $form['field_crew_start_time']['#prefix'] = "<table><tr><td>";
    $form['field_crew_start_time']['#suffix'] = "</td>";
    $form['field_crew_length_of_time']['#prefix'] = "<td>";
    $form['field_crew_length_of_time']['#suffix'] = "</td></tr></table>";
    if (!$form['nid']['#value']) {
      $form['actions']['submit']['#value'] = t('Create Crew Request');
    }

  }

  //The Crew Connect Applicant Form
  if ($form_id == 'crew_connect_application_node_form') {
/*http://cm-testing.mnn.openflows.com/node/add/crew-connect-application?field_app_crew_connect_node=779614&field_app_producer=207293&destination=user/207293/cm_crew_connect  
*/
    
    $public_email = cm_crew_connect_get_public_email($author->uid);

    $form['field_app_apps_public_email'][LANGUAGE_NONE][0]
      ['value']['#default_value'] = $public_email;
      
    $form['field_app_apps_public_email'][LANGUAGE_NONE]['#disabled'] = TRUE;       
    
    $form['actions']['submit']['#value'] = t('Sign Up');
  }

  if ($form['#action'] == '/crew-connect/requests-search') {
    $form['title']['#description'] = 
      'This only shows Projects that have active Crew Requests.';
    $form['submit']['#value'] = "Search";
  }

  if ($form_id == 'node_delete_confirm' && 
      $form['#node']->type == 'crew_connect_request') {
    $nid = arg(1);
    $node = $nid ? node_load($nid) : NULL;
    $type = $node ? substr($node->title, strpos($node->title, ":") + 2) : '';  

    $text = "<h3>".
      t('Are you sure you want to Cancel this "!type" Crew Request?',
	array('!type' => $type))."</h3>";
    
    $form['description']['#markup'] = $text;
    $form['actions']['submit']['#value'] = 'Yes';
    $form['actions']['cancel']['#title'] = 'No';

  }
  else if ($form_id == 'node_delete_confirm' && 
      $form['#node']->type == 'crew_connect_application') {
    $text = "<h3>".
      t('Are you sure you want to Cancel this Crew Sign Up?',
	array('!type' => $type))."</h3>";
    
    $form['description']['#markup'] = $text;
    $form['actions']['submit']['#value'] = 'Yes';
    $form['actions']['cancel']['#title'] = 'No';

  }
}

